# docker/docker-compose.yml

version: "3.8"

services:
  gateway:
    image: gnzsnz/ib-gateway:stable
    container_name: ibkr-gateway
    ports:
      - "127.0.0.1:4001:4001"  # Live trading (not used for paper)
      - "127.0.0.1:4002:4004"  # Paper trading: SOCAT proxy on 4004 forwards to API
      - "127.0.0.1:5900:5900"  # VNC (debugging)
      - "127.0.0.1:6080:6080"  # noVNC web interface
    environment:
      # Credentials
      - TWS_USERID=${IBKR_USERNAME}
      - TWS_PASSWORD=${IBKR_PASSWORD}
      - TRADING_MODE=paper

      # Timezone (for proper market hours handling)
      - TIME_ZONE=America/New_York

      # 2FA handling: restart on timeout for fresh attempt
      - TWOFA_TIMEOUT_ACTION=restart
      - RELOGIN_AFTER_TWOFA_TIMEOUT=yes

      # IBC behavior settings
      - ACCEPT_INCOMING_CONNECTION_ACTION=accept
      - ALLOW_BLIND_TRADING=yes
      - EXISTING_SESSION_DETECTED_ACTION=primary
      - STORE_SETTINGS_ON_SERVER=no
      - READ_ONLY_API=no
      - BYPASS_WARNING=yes

      # TASK-3.4.1: Explicitly set API port to 4002 for paper trading
      - OVERRIDE_TWS_API_PORT=4002

      # Allow API connections from Docker network (not just 127.0.0.1)
      - TWS_ACCEPT_INCOMING=accept

      # Enable IBC trace logging for debugging
      - IBC_LOGLEVEL=Debug

      # Disable Gateway's internal auto-restart (we use scheduled restart)
      - AUTO_RESTART_TIME=

      # VNC password for debugging access (optional)
      - VNC_SERVER_PASSWORD=${VNC_PASSWORD:-}
    volumes:
      - gateway-data:/home/ibgateway/Jts
      # Custom jts.ini template with TrustedIPs empty (allows Docker network connections)
      - ./gateway/jts.ini.tmpl:/home/ibgateway/Jts/jts.ini.tmpl:ro
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/4004"]  # SOCAT proxy port
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - trading-network

  trading-bot:
    build:
      context: ../
      dockerfile: docker/bot/Dockerfile
    container_name: trading-bot
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      - GATEWAY_HOST=gateway
      - GATEWAY_PORT=4004  # TASK-3.4.1: Connect to SOCAT proxy (4004 -> TWS API)
      - GATEWAY_STARTUP_TIMEOUT=${GATEWAY_STARTUP_TIMEOUT:-300}
      - GATEWAY_MAX_RETRIES=${GATEWAY_MAX_RETRIES:-30}
      - GATEWAY_RETRY_INTERVAL=${GATEWAY_RETRY_INTERVAL:-5}
      - GAMEPLAN_PATH=/data/gameplan.json
      - DRY_RUN=${DRY_RUN:-true}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - CLIENT_ID=${CLIENT_ID:-1}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/data:ro
      - bot-logs:/app/logs
    restart: unless-stopped
    networks:
      - trading-network

  health-monitor:
    build:
      context: ../monitoring
      dockerfile: Dockerfile
    container_name: health-monitor
    depends_on:
      - gateway
    environment:
      # Discord Integration
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - DISCORD_OPERATOR_MENTION=${DISCORD_OPERATOR_MENTION:-}
      # Gateway Configuration
      - GATEWAY_CONTAINER_NAME=${GATEWAY_CONTAINER_NAME:-ibkr-gateway}
      - GATEWAY_HOST=${GATEWAY_HOST:-gateway}
      - GATEWAY_PORT=4004  # TASK-3.4.1: Connect to SOCAT proxy
      - GATEWAY_RESTART_TIMEOUT_SECONDS=${GATEWAY_RESTART_TIMEOUT_SECONDS:-30}
      - GATEWAY_READY_MAX_ATTEMPTS=${GATEWAY_READY_MAX_ATTEMPTS:-12}
      - GATEWAY_READY_CHECK_INTERVAL_SECONDS=${GATEWAY_READY_CHECK_INTERVAL_SECONDS:-5}
      # Health Check Configuration
      - HEALTH_CHECK_INTERVAL_SECONDS=${HEALTH_CHECK_INTERVAL_SECONDS:-60}
      - PORT_CHECK_TIMEOUT_SECONDS=${PORT_CHECK_TIMEOUT_SECONDS:-3}
      - ERROR_RECOVERY_INTERVAL_SECONDS=${ERROR_RECOVERY_INTERVAL_SECONDS:-120}
      # Memory Thresholds
      - MEMORY_WARNING_MB=${MEMORY_WARNING_MB:-1536}
      - MEMORY_CRITICAL_MB=${MEMORY_CRITICAL_MB:-1740}
      # Alert Throttling
      - ALERT_COOLDOWN_SECONDS=${ALERT_COOLDOWN_SECONDS:-300}
      # Bot Monitoring (Optional - MVP defaults to disabled)
      - MONITOR_BOT_HEALTH=${MONITOR_BOT_HEALTH:-false}
      - BOT_DEPLOYMENT_MODE=${BOT_DEPLOYMENT_MODE:-none}
      - BOT_CONTAINER_NAME=${BOT_CONTAINER_NAME:-trading-bot}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker API access
    restart: unless-stopped
    networks:
      - trading-network

volumes:
  gateway-data:
  bot-logs:

networks:
  trading-network:
    driver: bridge
